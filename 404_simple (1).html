<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>404 • Küssnacht Area Guide • POIs (Simple Pins)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    html, body { height: 100%; margin: 0; }
    #map { width: 100%; height: 100%; }
    .legend {
      position: absolute; bottom: 16px; left: 16px; z-index: 1000;
      background: rgba(255,255,255,0.95); padding: 10px 12px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.12); font: 14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend img { width: 18px; height: 28px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend" id="legend"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="data.js"></script>
  <script>
    const DEFAULT = { lat: 47.0850, lng: 8.4430, z: 13 };

    function getParams() {
      const out = {};
      const qs = new URLSearchParams(location.search);
      for (const [k, v] of qs.entries()) out[k] = v;
      if (location.hash && location.hash.length > 1) {
        const hs = new URLSearchParams(location.hash.slice(1));
        for (const [k, v] of hs.entries()) if (!(k in out)) out[k] = v;
      }
      return out;
    }
    function f(x, d){ const v = parseFloat(x); return Number.isFinite(v) ? v : d; }

    // Colored PNG pins (no plugins)
    const ICONS = {
      "green":     "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-green.png",
      "blue":      "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-blue.png",
      "red":       "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-red.png",
      "orange":    "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-orange.png",
      "violet":    "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-violet.png",
      "gold":      "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-gold.png",
      "grey":      "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-grey.png",
      "black":     "https://unpkg.com/leaflet-color-markers@1.0/img/marker-icon-2x-black.png"
    };
    const SHADOW = "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png";

    function iconFor(color) {
      const url = ICONS[(color||"").toLowerCase()] || ICONS["grey"];
      return new L.Icon({
        iconUrl: url, shadowUrl: SHADOW,
        iconSize: [25, 41], iconAnchor: [12, 41],
        popupAnchor: [1, -34], shadowSize: [41, 41]
      });
    }

    // Build map
    const p = getParams();
    const center = [ f(p.lat, DEFAULT.lat), f(p.lng, DEFAULT.lng) ];
    const zoom   = parseInt(p.z || DEFAULT.z, 10);
    const map = L.map('map').setView(center, zoom);
    window.map = map;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const pois = Array.isArray(window.POIS) ? window.POIS : [];
    const cats = new Set();
    pois.forEach(d => {
      if (!(Number.isFinite(d.lat) && Number.isFinite(d.lng))) return;
      const color = (d.icon_color || d.category || "").toLowerCase();
      cats.add(color || "grey");
      L.marker([d.lat, d.lng], { icon: iconFor(color) })
        .addTo(map)
        .bindPopup(`<b>${d.name || "(Unnamed)"}<\/b><br>${d.description || ""}`);
    });

    // Legend
    const legend = document.getElementById("legend");
    legend.innerHTML = "<b>Legend</b>" + Array.from(cats).sort().map(c => {
      const url = ICONS[c] || ICONS["grey"];
      const label = c || "other";
      return `<div class="row"><img src="${url}" alt=""> ${label}</div>`;
    }).join("");
  </script>
</body>
</html>
